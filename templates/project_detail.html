<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ project_title }} - Living Repository</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <!-- Navigation -->
  <nav class="nav" style="display:flex; justify-content:space-between; align-items:center; padding:var(--space-4) var(--space-6); border-bottom:1px solid var(--border-color);">
    <div class="logo h3">Living Repository</div>
    <div>
      <a href="{{ url_for('projects') }}" class="btn btn-link">My Projects</a>
      <a href="{{ url_for('logout') }}" class="btn btn-link">Logout</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main style="max-width:1000px; margin:auto; padding:20px;">
    <div class="doc-card" style="padding:var(--space-8); margin-bottom:24px; position:relative;">
      <h1 class="h2">{{ project_title }}</h1>
      <p class="muted">{{ project_description or "No description provided." }}</p>
      
      <!-- Delete Project Button -->
      <button id="deleteProjectBtn" class="btn btn-danger" style="position:absolute; top:16px; right:16px;">Delete Project</button>

      <div style="display:flex; gap:var(--space-4); margin-top:12px;">
        <a href="{{ url_for('ingestion', project_id=project_id) }}" class="btn btn-primary">Go to Ingestion</a>
        <a href="{{ url_for('projects') }}" class="btn btn-secondary">Back to Projects</a>
      </div>
    </div>

    <!-- Chat Section & Sharing -->
    <div style="margin-top:20px; display:flex; gap:var(--space-4);">
      <a href="{{ url_for('project_chats', project_id=project_id) }}" class="btn btn-primary">
        Open Project Chats
      </a>
      <button id="openShareModal" class="btn btn-accent">Share Project</button>
    </div>

    <!-- Share Link Result -->
    <div id="shareLinkContainer" style="margin-top:16px; display:none;">
      <div class="doc-card" style="padding:var(--space-6);">
        <p><strong>Share Link:</strong> <a id="shareLink" href="#" target="_blank"></a></p>
        <p><em>Expires:</em> <span id="shareExpiry"></span></p>
        <p><em>Permissions:</em> <span id="sharePerms"></span></p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="section" style="text-align:center; padding:var(--space-8); border-top:1px solid var(--border-color); margin-top:var(--space-16);">
    <p class="muted text-sm">&copy; {{ current_year }} Living Repository. All rights reserved.</p>
  </footer>

  <!-- Share Modal -->
  <div id="shareModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
    <div style="background:white; padding:24px; border-radius:12px; width:100%; max-width:400px;">
      <h2 class="h3">Generate Share Link</h2>
      <form id="shareForm">
        <label for="permissions">Permissions</label>
        <select id="permissions" name="permissions" style="width:100%; margin-bottom:12px;" required>
          <option value="read">Read-only</option>
          <option value="write">Edit</option>
          <option value="admin">Admin</option>
        </select>

        <label for="expiry">Expiry Date</label>
        <input type="date" id="expiry" name="expiry" style="width:100%; margin-bottom:16px;" required>

        <div style="display:flex; justify-content:flex-end; gap:12px;">
          <button type="button" id="closeShareModal" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Generate</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
    <div style="background:white; padding:24px; border-radius:12px; width:100%; max-width:400px;">
      <h2 class="h3">Confirm Project Deletion</h2>
      <p>Are you sure you want to delete this project? This action cannot be undone.</p>
      <form id="deleteForm" method="POST" action="">
        <input type="hidden" name="confirm_delete" value="yes">
        <div style="display:flex; justify-content:flex-end; gap:12px;">
          <button type="button" id="closeDeleteModal" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script>
    // Share modal toggle
    document.getElementById("openShareModal").addEventListener("click", () => {
      document.getElementById("shareModal").style.display = "flex";
    });
    document.getElementById("closeShareModal").addEventListener("click", () => {
      document.getElementById("shareModal").style.display = "none";
    });

    // Handle share form submit
    document.getElementById("shareForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const permissions = document.getElementById("permissions").value;
      const expiry = document.getElementById("expiry").value;

      if (!expiry) {
        alert("Please select an expiry date.");
        return;
      }

      const res = await fetch(`/project/{{ project_id }}/share`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ permissions, expiry })
      });

      const data = await res.json();
      if(data.error){
        alert(data.error);
        return;
      }

      const linkContainer = document.getElementById("shareLinkContainer");
      document.getElementById("shareLink").href = data.share_url;
      document.getElementById("shareLink").textContent = data.share_url;
      document.getElementById("shareExpiry").textContent = new Date(data.expires).toLocaleString();
      document.getElementById("sharePerms").textContent = data.permissions;

      linkContainer.style.display = "block";
      document.getElementById("shareModal").style.display = "none";
    });

    // Delete modal toggle
    document.getElementById("deleteProjectBtn").addEventListener("click", () => {
      document.getElementById("deleteModal").style.display = "flex";
    });
    document.getElementById("closeDeleteModal").addEventListener("click", () => {
      document.getElementById("deleteModal").style.display = "none";
    });
  </script>
</body>
</html>
