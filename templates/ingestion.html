<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ project.title }} — Ingestion</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

  <!-- Header -->
  <header class="container header">
    <a class="brand" href="{{ url_for('index') }}">Living Repository</a>
    <nav class="nav">
      <a href="{{ url_for('projects') }}">Projects</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </nav>
  </header>

  <main class="container">

    <!-- Step Header -->
    <div class="ingest-steps">
      <div class="ingest-step active" data-step="dashboard" aria-current="page">Dashboard</div>
      <div class="ingest-step" data-step="upload">Upload</div>
      <div class="ingest-step" data-step="tags">AI Tag Suggestions</div>
      <div class="ingest-step" data-step="metadata">Metadata</div>
    </div>

    <div class="ingest-screens">

      <!-- DASHBOARD -->
      <section class="screen active" data-screen="dashboard">
        <h2 class="h2">{{ project.title }} — Documents</h2>
        <div style="margin:8px 0 24px 0;">
          <a href="{{ url_for('project_detail', project_id=project_id) }}">
            <button class="btn btn-outline">← Back to Project</button>
          </a>
        </div>

        <!-- Search -->
        <div style="display:flex; justify-content:center; margin-bottom:24px;">
          <input id="docSearch" class="input" placeholder="Search documents…" style="max-width:500px; flex:1" />
          <button id="docSearchBtn" class="btn btn-outline">Search</button>
        </div>

        <!-- Upload button -->
        <div style="display:flex; justify-content:center; margin-bottom:24px;">
          <button class="btn btn-primary btn-lg" id="btnGoUpload">+ Upload New Document</button>
        </div>

        <!-- Document List -->
        <article class="doc-card">
        <a href="{{ url_for('document_detail', project_id=project_id, doc_id=doc.doc_id) }}" style="text-decoration:none; color:inherit; display:block;">
          <div class="doc-row">
            <div class="doc-title">{{ doc.title }}</div>
            <span class="badge
              {% if doc.status == 'Complete' %}badge-success
              {% elif doc.status in ['In Progress','in_progress','in progress'] %}badge-warning
              {% elif doc.status in ['Failed','Error'] %}badge-danger
              {% else %}badge-secondary{% endif %} status-badge">
              {{ doc.status or "Pending" }}
            </span>
          </div>

          <div class="doc-meta">
            <span>Author: {{ doc.author or "Unknown" }}</span>
            <span>Updated: {{ doc.upload_date }}</span>
          </div>

          {% if doc.tags %}
          <div class="doc-tags" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
            {% for tag in doc.tags.split(",") %}
              <span class="badge badge-secondary">{{ tag.strip() }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </a>

        <!-- Process Button (outside link so it’s clickable separately) -->
        {% if doc.status != 'Complete' %}
        <button class="btn btn-sm btn-primary process-btn" data-doc-id="{{ doc.doc_id }}">
          Process
        </button>
        {% endif %}
      </article>

          <!-- Process Button -->
          {% if doc.status != 'Complete' %}
          <button class="btn btn-sm btn-primary process-btn" data-doc-id="{{ doc.doc_id }}">
            Process
          </button>
          {% endif %}
        </article>
        {% endfor %}

      <!-- UPLOAD -->
      <section class="screen" data-screen="upload">
        <h2 class="h2">Upload Document</h2>

        <form id="uploadForm" enctype="multipart/form-data">
          <div id="dropzone" class="dropzone" tabindex="0">
            <input id="fileInput" name="file" type="file" hidden />
            <div class="dropzone-inner">
              <div class="drop-illustration">⬆</div>
              <div class="drop-title">Drag & drop file here</div>
              <div class="drop-sub">or <button id="browseBtn" type="button" class="btn btn-link">browse</button></div>
              <div class="drop-hint">PDF, DOCX, or image only. Max 25MB.</div>
              <div id="filePicked" class="drop-picked" hidden></div>
            </div>
          </div>

          <input id="docTitle" name="title" class="input" placeholder="Document title" required />
          <textarea id="docDescription" name="description" class="input" placeholder="Optional description"></textarea>
          <select id="docPrivacy" name="privacy" class="select" required>
            <option value="internal" selected>Internal</option>
            <option value="public">Public</option>
            <option value="confidential">Confidential</option>
          </select>

          <div class="ingest-actions">
            <button class="btn btn-outline" id="backToDashboard" type="button">Back</button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>
      </section>

      <!-- TAGS -->
      <section class="screen" data-screen="tags">
        <h2 class="h2">AI Tag Suggestions</h2>
        <div class="chip-board" id="suggestedTags"></div>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <input id="manualTag" class="input" placeholder="Add manual tag" />
          <button id="addTagBtn" class="btn btn-outline">Add Tag</button>
        </div>
        <div class="ingest-actions">
          <button class="btn btn-outline" id="backToUpload">Back</button>
          <button class="btn btn-primary" id="toMetadata">Continue</button>
        </div>
      </section>

      <!-- METADATA -->
      <section class="screen" data-screen="metadata">
        <h2 class="h2">Finalize Metadata</h2>
        <div class="card" style="padding: var(--space-6); border-radius:16px; background:#fff; box-shadow:var(--shadow);">
          <div class="group-block">
            <div class="group-title">Tags</div>
            <div class="chip-board" id="finalTags"></div>
          </div>
          <div class="group-block">
            <div class="group-title">Classification</div>
            <select id="classification" class="select">
              <option value="public">Public</option>
              <option value="internal" selected>Internal</option>
              <option value="confidential">Confidential</option>
            </select>
          </div>
          <div class="group-block">
            <div class="group-title">Reviewer</div>
            <input id="reviewer" class="input" list="reviewerList" placeholder="Start typing…" />
            <datalist id="reviewerList">
              <option value="Alex Johnson"></option>
              <option value="Priya Singh"></option>
              <option value="Taylor Wong"></option>
              <option value="Morgan Lee"></option>
            </datalist>
          </div>
          <div class="ingest-actions">
            <button class="btn btn-outline" id="backToTags">Back</button>
            <button class="btn btn-primary" id="submitRepo">Submit to Repository</button>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="container footer">
    <small>© <span id="year"></span> Living Repository</small>
  </footer>

  <!-- JS -->
  <script>
    document.querySelectorAll('.process-btn').forEach(btn => {
    btn.addEventListener('click', () => {
    const docId = btn.dataset.docId;
    fetch(`/project/${PROJECT_ID}/document/${docId}/process`, {
        method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
          if(data.success){
            const card = btn.closest('.doc-card');
            const badge = card.querySelector('.status-badge');
            badge.textContent = 'Complete';
            badge.className = 'badge badge-success status-badge';
            btn.remove(); // remove the process button
          } else {
            alert('Failed to process document.');
          }
        })
        .catch(err => console.error(err));
      });
    });
    document.getElementById('year').textContent = new Date().getFullYear();
    const screens = document.querySelectorAll('.screen');
    const steps = document.querySelectorAll('.ingest-step');
    const PROJECT_ID = "{{ project_id }}";

    function goToScreen(screenName) {
      screens.forEach(s => s.classList.toggle('active', s.dataset.screen === screenName));
      steps.forEach(step => {
        const active = step.dataset.step === screenName;
        step.classList.toggle('active', active);
        if(active) step.setAttribute('aria-current','page');
        else step.removeAttribute('aria-current');
      });
    }

    // Navigation buttons
    document.getElementById('btnGoUpload').addEventListener('click', () => goToScreen('upload'));
    document.getElementById('backToDashboard').addEventListener('click', () => goToScreen('dashboard'));
    document.getElementById('backToUpload')?.addEventListener('click', () => goToScreen('upload'));
    document.getElementById('backToTags')?.addEventListener('click', () => goToScreen('tags'));
    document.getElementById('toMetadata')?.addEventListener('click', () => goToScreen('metadata'));

    // File input
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const filePicked = document.getElementById('filePicked');
    browseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if(fileInput.files.length > 0){
        filePicked.hidden = false;
        filePicked.textContent = `Selected file: ${fileInput.files[0].name}`;
      } else { filePicked.hidden = true; }
    });

    // AJAX upload
    const uploadForm = document.getElementById('uploadForm');
    const docList = document.getElementById('docList');

    uploadForm.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(uploadForm);

      fetch(`/project/${PROJECT_ID}/upload`, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if(data.success){
          const article = document.createElement('article');
          article.className = 'doc-card';
          article.innerHTML = `
            <div class="doc-row">
              <div class="doc-title">${data.title}</div>
              <span class="badge badge-secondary">Pending</span>
            </div>
            ${data.description ? `<p class="text-sm muted" style="margin-top:6px;">${data.description}</p>` : ''}
          `;
          docList.prepend(article);
          uploadForm.reset();
          filePicked.hidden = true;
          alert('Document uploaded successfully!');
          goToScreen('dashboard');
        } else {
          alert('Upload failed');
        }
      }).catch(err => console.error(err));
    });
  </script>
</body>
</html>
